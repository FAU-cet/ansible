# Generated by Anaconda 34.25.1.14
# Generated by pykickstart v3.32
#version=RHEL9

# Use none-intractive install // changed from grafical
text --non-interactive

url --url=https://ftp.fau.de/almalinux/9.3/BaseOS/x86_64/os/

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

# Keyboard layouts
keyboard --xlayouts='us'
# System language
lang en_US.UTF-8


# Network information
#network  --onboot=yes --device=ens160 --bootproto=dhcp --noipv6 --activate
#network  --hostname=almalinux-custom.localdomain
network --activate
# install server invorment with now extras
%packages
@^server-product-environment

%end

# Run the Setup Agent on first boot
firstboot --enable

# System timezone
timezone Europe/Berlin --utc
# timesource --ntp-server ntp0.fau.de

# Root password
rootpw --iscrypted $6$cOz7lbJSW9YNSN02$D2ZH4NTsz2NGh9ZDf.H84B8SyWQeeNUFapHXyjwC4SQJXtm1kBNEb.ImqPwm791A6OZjZyNY5RlXYS3ZC1Yqg/

# acsept license
eula --agreed

reboot

%pre
#!/bin/bash
selected_disk=""
# iterate over disks by chatGPT
for disk in $(lsblk -n -b -o SIZE,NAME | awk '$1 >= 400*1024*1024*1024 && $1 <= 1200*1024*1024*1024 {print $2}'); do
  if [[ -z "$selected_disk" ]]; then
    selected_disk=$disk
  fi
done
selected_disk="sda"
# anaconda dose not support bash in sections so commands hafe to be written to a file with will be in cluded
echo "clearpart --all --initlabel --drives $selected_disk" > /tmp/disk_selection.ks
echo "part /boot --fstype ext4 --size 1024 --ondisk $selected_disk" >> /tmp/disk_selection.ks
echo "part pv.01 --grow --size=1 --ondisk $selected_disk" >> /tmp/disk_selection.ks
echo "volgroup alma --pesize 4096 pv.01" >> /tmp/disk_selection.ks
echo "logvol / --fstype xfs --name root --vgname alma --size 71680" >> /tmp/disk_selection.ks
echo "logvol swap --fstype swap --name swap --vgname alma --size 8192" >> /tmp/disk_selection.ks
echo "logvol /home --fstype xfs --name home --vgname alma --size 1 --grow" >> /tmp/disk_selection.ks
echo "bootloader --boot-drive $selected_disk --driveorder $selected_disk --location mbr" >> /tmp/disk_selection.ks

%end

%include /tmp/disk_selection.ks

%post
# setting the ntp server with the kickstart did not work
echo "server ntp0.fau.de" >> /etc/ntp.conf
systemctl enable --now ntpd
%end
